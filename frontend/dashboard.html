<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live MART | Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Orbitron:400,700&display=swap" rel="stylesheet">
    
    <style>
        /* Search Button Style */
        .nav-search-btn {
            display: flex !important; align-items: center; justify-content: center;
            width: 35px; height: 35px; padding: 0 !important; margin: 0 !important;
            border-radius: 50%; background: #f5f5f5; color: #333; border: 1px solid #ddd;
            transition: all 0.3s ease; text-decoration: none !important; position: relative; top: 2px;
        }
        .nav-search-btn:hover { background: #000; color: #00f3ff; border-color: #00f3ff; }
        
        /* Cart Badge */
        .cart-count {
            position: absolute; top: -8px; right: -8px; background: #ff013c; color: #fff;
            font-size: 10px; padding: 2px 5px; border-radius: 50%; font-weight: bold;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html"><h3>Live MART</h3></a>
            </div>
            <ul class="nav navbar-nav navbar-right" style="display: flex; align-items: center; height: 50px;">
                <li style="list-style: none; margin-right: 15px; position: relative;">
                    <a href="cart.html" class="nav-search-btn" title="My Cart">
                        <i class="fa fa-shopping-cart"></i>
                        <span id="cart-badge" class="cart-count" style="display:none;">0</span>
                    </a>
                </li>
                <li style="list-style: none; margin-right: 15px;">
                    <a href="orders.html" class="nav-search-btn" title="My Orders">
                        <i class="fa fa-list"></i>
                    </a>
                </li>
                <li style="margin-right: 20px; list-style: none;">
                    <span class="nav-welcome-text">Welcome, <b id="user-name-display">Guest</b></span>
                </li>
                <li style="list-style: none;">
                    <button id="auth-button" class="btn-product" style="padding: 5px 15px; font-size: 12px;">Login</button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="category-nav-container">
        <div class="container text-center">
            <a class="cat-pill active" onclick="filterProducts('all')">All</a>
            <a class="cat-pill" onclick="filterProducts('Electronics')">Electronics</a>
            <a class="cat-pill" onclick="filterProducts('Fashion')">Fashion</a>
            <a class="cat-pill" onclick="filterProducts('Groceries')">Groceries</a>
            <a class="cat-pill" onclick="filterProducts('Home')">Home</a>
            <a class="cat-pill" onclick="filterProducts('Sports')">Sports</a>
        </div>
    </div>

    <div class="container" style="min-height: 600px;">
        <div class="row">
            <div class="col-md-12">
                <h4 style="margin-bottom: 25px; color: #000; font-size: 2.5rem;"><b>Available Near You</b></h4>
            </div>
        </div>

        <div class="row" id="product-grid">
            </div>
    </div>

    <footer>
        <div class="container text-center">
            <p>© 2025 Live MART. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- 1. INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            fetchProducts('all');
            updateCartCount();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('user_role');
            const userNameDisplay = document.getElementById('user-name-display');
            const authButton = document.getElementById('auth-button');
            
            if (!token) {
                userNameDisplay.innerHTML = "Guest";
                authButton.textContent = "Login";
                authButton.onclick = () => window.location.href = 'Customer.html';
            } else {
                userNameDisplay.textContent = role ? role.charAt(0).toUpperCase() + role.slice(1) : "User";
                authButton.textContent = "Logout";
                authButton.onclick = () => {
                    localStorage.clear();
                    window.location.href = 'index.html';
                };
            }
        }

        // --- 2. FETCH PRODUCTS ---
        async function fetchProducts(category) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '<div class="text-center" style="padding:50px;"><i class="fa fa-circle-o-notch fa-spin" style="font-size:24px; color:#00f3ff;"></i></div>';

            try {
                // Construct URL - Assumes you added /products/all endpoint to main.py
                let url = '/products/all';
                if (category && category !== 'all') {
                    url += `?category=${encodeURIComponent(category)}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load products");
                
                const products = await response.json();
                renderProducts(products);
            } catch (error) {
                console.error(error);
                grid.innerHTML = `<div class="text-center text-danger">Failed to fetch products. Make sure backend is running.</div>`;
            }
        }

        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<div class="text-center"><h5>No products found in this category.</h5></div>';
                return;
            }

            products.forEach(p => {
                let btnHtml = '';
                let badgeHtml = '';

                if (p.stock <= 0) {
                    badgeHtml = `<span class="badge-overlay bg-out">Out of Stock</span>`;
                    btnHtml = `<button class="btn-product btn-notify" disabled>Notify Me</button>`;
                } else {
                    badgeHtml = `<span class="badge-overlay bg-stock">Stock: ${p.stock}</span>`;
                    btnHtml = `<button class="btn-product btn-add" onclick="addToCart(${p.id})">Add to Cart</button>`;
                }

                // Using default image if null
                const imgUrl = p.image_url || 'https://via.placeholder.com/200?text=No+Image';

                const html = `
                <div class="col-md-3 col-sm-6" style="margin-bottom: 30px;">
                    <div class="product-card">
                        ${badgeHtml}
                        <div class="card-img-wrap">
                            <a href="product-details.html?id=${p.id}">
                                <img src="${imgUrl}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/200?text=Error'">
                            </a>
                        </div>
                        <div class="card-body">
                            <a href="product-details.html?id=${p.id}" style="text-decoration:none; color:inherit;">
                                <div class="card-title">${p.name}</div>
                            </a>
                            <span class="card-price">₹${p.price}</span>
                            ${btnHtml}
                        </div>
                    </div>
                </div>`;
                grid.innerHTML += html;
            });
        }

        // --- 3. ADD TO CART ---
        async function addToCart(productId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("Please login first!");
                window.location.href = 'Customer.html';
                return;
            }

            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ product_id: productId, quantity: 1 })
                });

                if (response.ok) {
                    alert("Item added to cart!");
                    updateCartCount(); // Refresh badge
                } else {
                    const err = await response.json();
                    alert("Error: " + err.detail);
                }
            } catch (e) {
                console.error(e);
                alert("Network error adding to cart.");
            }
        }

        // --- 4. HELPER: Update Badge ---
        async function updateCartCount() {
            const token = localStorage.getItem('token');
            if(!token) return;

            try {
                const res = await fetch('/cart', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('cart-badge');
                    if(data.total_size > 0) {
                        badge.textContent = data.total_size;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch(e) { console.error("Cart fetch error", e); }
        }

        // --- 5. FILTERS ---
        function filterProducts(cat) {
            document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            fetchProducts(cat);
        }
    </script>
</body>
</html>